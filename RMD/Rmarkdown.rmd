---
title: "Homework2"
author: "xhy2012011530"
date: "2015年12月5日"
output: html_document
---
**<font size=3>1.读取数据</font>**
```{r}
setwd('A:/学习/大四上/生物信息学概论/作业/HomeworkII')#修改路径
rt<-readLines("GeneMatrix.txt")  #读出信息 
m<-length(rt)-1  #病人数
n<-length(strsplit(rt[1],'\t')[[1]])#基因数
sq<-matrix(0,m,n)  #表达信息矩阵
for (i in 1:m+1){  #对于每个基因对应的行
  sq1<-strsplit(rt[i],'\t')        #分割成字符串
  sq1<-c(sq1[[1]][1:n+1])   #取数字部分
  sq1<-as.double(sq1)   #字符串转成双精度
  sq[i-1,]<-sq1    #存储至表达信息矩阵
}
sq0<-sq
```
**<font size=3>2.层次聚类</font>**
```{r}
dist.e<-dist(t(sq),method='euclidean')  #计算样本矩阵欧几里得距离
heatmap(as.matrix(dist.e),labRow = F, labCol = F) #画出热点图
```
```{r}
clust_tree<-hclust(dist.e,method='average')  #使用类平均法进行层次聚类
plot(clust_tree)  #画出聚类示意图
```
```{r}
result<-cutree(clust_tree,k=2) #根据heatmap可以看出样本可以分为两类，提取每个样本的所属类别
plot(result) #画出分类结果
```
  
  <font size=2>对该组数据样本按照基因表达水平进行聚类，画出heatmap图，可以看出heatmap图中存在两块深颜色区域和两块淡颜色区域，说明病人中有一部分高度相关，另一部分相关程度不高，即可以按照基因表达水平将病人分成两类；这一点也可以从cutree图看出，编号向量中秩在410（左右）以下的病人大部分高度相关,410（左右）以上的病人大部分高度相关，这和heatmap得到的结果是不谋而合的；从Cluster图上我们也可以看出整个聚类树呈现出两部分的趋势。</font>
  
  **<font size=3>3.PCA</font>**
  
  <font size=2>PCA计算过程：  
  1. 对样本数据进行标准化  
  2. 计算标准化样本数据协方差矩阵  
  3. 计算的特征值和对应的特征向量  
  4. 对特征值进行排序，根据阈值选取前m个特征值所对应的特征向量作为主成分方向  
  5. 计算各样本数据在主成分方向上的投影       
  本次作业中选取阈值thresh为95%，此时主成分数为155（特征值之和占比达到thresh（95%）），降维之后的数据为155*522大小。用降维之后的数据再次进行层次聚类</font>
```{r}
for(i in 1:m){    #样本数据标准化
  sq[i,]<-(sq[i,]-mean(sq[i,]))/sd(sq[i,])
}
temp<-sq%*%t(sq)  #协方差
ev<- eigen(temp)  #特征值和特征向量，从大到小排列
su<-sum(unlist(ev[1])) #特征值之和
s0<-0   
thresh<-0.95  #如果当前主成分的特征值之和达到阈值，则跳出
for(i in 1:m){
  s0<-s0+ev[[1]][i]
  if(s0/su>thresh)
    break
}
pcs<-t(t(sq0)%*%ev[[2]][,1:i])  #得到对应的主成分
```
**<font size=3>4.层次聚类After PCA</font>**
```{r}
dist.e<-dist(t(pcs),method='euclidean')#计算样本矩阵欧几里得距离
heatmap(as.matrix(dist.e),labRow = F, labCol = F)#画出热点图
```
```{r}
clust_tree<-hclust(dist.e,method='average')#使用类平均法进行层次聚类
plot(clust_tree)#画出聚类示意图
```
```{r}
result<-cutree(clust_tree,k=2)#根据heatmap可以看出样本可以分为两类，提取每个样本的所属类别
plot(result) #画出分类结果
```
  
  <font size=2>对照未进行PCA前的三幅图，PCA（155个主成分）之后再做层次聚类基本保持了病人之间原有的相关性和聚类效果，仍然可以通过heatmap将病人分为两类；cutree图上仍然是编号向量中秩在410（左右）以下的病人大部分高度相关,410（左右）以上的病人大部分高度相关；Cluster图几乎没变。</font>
  
  **<font size=3>5.Clinical_data检验</font>**
```{r}
#ID<-read.table("clipboard",F,'\t') #用Excel打开clinical_data,复制sampleID到剪切板
#ER<-read.table("clipboard",header=F,sep='\t' , fill = TRUE,blank.lines.skip = FALSE) #用Excel打开clinical_data，复制ER_Status_nature2012到剪切板
clinic_data<-read.table("clinical_data",header=F,sep="\t" , fill = TRUE,blank.lines.skip = FALSE,quote = "")#读取数据
#clinic_data<-read.csv("clinical_data",header=F,sep="\t" , fill = TRUE,blank.lines.skip = FALSE)
ID<-clinic_data[1]
ER<-clinic_data[8]
ID<-unlist(ID)  #去列表
ER<-unlist(ER)#去列表
l<-length(ER)
ID<-ID[1:l]
ID<-as.character(ID)#转成字符串
ER<-as.character(ER)#转成字符串
ERreal<-ER
Index<-rep(0,n)
sample_ID<-unlist(strsplit(rt[1],'\t')) #GeneMatrix病人编号
for(i in 1:n){
  Index[i]<-grep(sample_ID[i],ID,value=F) #病人编号的位置
  ERreal[i]<-ER[Index[i]] #病人对应的ER_Status_nature2012
}
ERreal<-ERreal[1:n] #取GeneMatrix对应的ER_Status_nature2012信息
```  
```{r, echo=FALSE}
cat("1-15:",ERreal[1:15],"......","\n400-415:",ERreal[400:415],"......","\n507-522:",ERreal[507:522])
```

  <font size=2>由上面ERreal的值可得，在编号向量中秩在404以下的病人全为Positive,404以上的病人全为Negative,这和cutree图中编号向量中秩在410（左右）以下的病人大部分高度相关,410（左右）以上的病人大部分高度相关是十分吻合的，也从侧面验证了我所做的层次聚类的正确性，也说明聚类效果符合预期。</font>